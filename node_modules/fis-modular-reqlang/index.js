/*
 * fis
 * http://web.baidu.com/
 */

'use strict';

function addSameNameDeps(file, ext, fis){
    var path;
    if(fis.util.isFile(file.realpathNoExt + ext)){
        path = './' + file.filename + ext;
    } else {
        var map = fis.config.get('roadmap.ext');
        for(var key in map){
            if(map.hasOwnProperty(key)){
                var rExt = map[key];
                if(rExt === ext && fis.util.isFile(file.realpathNoExt + rExt)) {
                    path = './' + file.filename + rExt;
                    break;
                }
            }
        }
    }
    if(path){
        var info = fis.uri.getId(path, file.dirname);
        file.addRequire(info.id);
    }
}

function analyseJs(content, file, fis){
    var reg = /"(?:[^\\"]|\\[\s\S])+"|'(?:[^\\']|\\[\s\S])+'|\/\/[\r\n]+|\/\*[\s\S]+?\*\/|\brequire\s*\(\s*("(?:[^\\"]|\\[\s\S])+"|'(?:[^\\']|\\[\s\S])+')\s*\)/g;
    content = content.replace(reg, function(m, value){
        if(value){
            var info = fis.uri.getId(value, file.dirname);
            file.addRequire(info.id);
            m = 'require(' + info.quote + info.id + info.quote + ')';
        }
        return m;
    });
    //wrap
    content = 'define(\'' + file.getId() + '\', [\'' + file.requires.join("', '") + '\'], function(require, exports, module){\n' + content + ';\nreturn exports;});';
    return content;
}

function analyseCss(content, file, fis){
    var reg = /@require\s+('[^']+'|"[^"]+"|[^\s{}]+)[\s;]*/g;
    return content.replace(reg, function(m, value){
        var info = fis.uri.getId(value, file.dirname);
        file.addRequire(info.id);
        return '';
    });
}

function analyseHtml(content, file, fis){
    addSameNameDeps(file, '.css', fis);
    addSameNameDeps(file, '.js', fis);
    return content;
}

module.exports = function(content, file, conf, fis){
    if(file.rExt === '.js'){
        return analyseJs(content, file, fis);
    } else if(file.rExt === '.css'){
        return analyseCss(content, file, fis);
    } else {
        return analyseHtml(content, file, fis);
    }
};